@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions
<!-- Select field container with error state class -->
<div class="master-select-field @(HasError ? "master-select-field--error" : "")"
     aria-label="@Label">

    <!-- Label with error color -->
    <label for="@Id"
           class="@(HasError ? "master-label--error" : "")">
        @Label
    </label>

    <!-- Select dropdown with error styling -->
    <select id="@Id"
            class="master-select @(HasError ? "master-select--error" : "")"
            value="@(Value ?? "")"
            @onchange="OnChange"
            disabled="@Disabled"
            aria-label="@Label"
            aria-invalid="@HasError">
        @if (!string.IsNullOrEmpty(Placeholder))
        {
            <option value="" disabled selected="@(string.IsNullOrEmpty(Value))">@Placeholder</option>
        }
        @foreach (var option in Options)
        {
            <option value="@option.Value" selected="@(Value == option.Value)">@option.Text</option>
        }
    </select>

    <!-- Dropdown arrow -->
    <div class="master-select-arrow">
        <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
            <path d="M1 1L6 7L11 1" stroke="#003663" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>
</div>
@code {
    [Parameter] public string? Label { get; set; }
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public List<SelectOption> Options { get; set; } = new();
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool Visible { get; set; }
    /// <summary>
    /// Expression to identify the bound field for validation
    /// </summary>
    [Parameter] public Expression<Func<string>>? For { get; set; }
    /// <summary>
    /// Cascaded EditContext from parent EditForm
    /// </summary>
    [CascadingParameter] private EditContext? EditContext { get; set; }
    /// <summary>
    /// Checks if the field has validation errors
    /// </summary>
    private bool _initialNotified;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && !_initialNotified && EditContext is not null
            && For is not null && !string.IsNullOrEmpty(Value))
        {
            _initialNotified = true;
            EditContext.NotifyFieldChanged(FieldIdentifier.Create(For));
        }
    }

    private bool HasError =>
        Visible &&
        EditContext is not null &&
        For is not null &&
        EditContext.GetValidationMessages(FieldIdentifier.Create(For)).Any();
    /// <summary>
    /// Handles selection changes and notifies parent
    /// </summary>
    private async Task OnChange(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);

        if (EditContext is not null && For is not null)
        {
            EditContext.NotifyFieldChanged(FieldIdentifier.Create(For));
        }
    }
}
