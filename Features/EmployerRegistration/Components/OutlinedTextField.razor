@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions
<!-- Text field container with error state class -->
<div class="master-text-field @(HasError ? "master-text-field--error" : "")"
     aria-label="@Label">

    <!-- Label with error color -->
    <label for="@Id"
           class="@(HasError ? "master-label--error" : "")">
        @Label
    </label>

    <!-- Input field with error styling -->
    <input id="@Id"
           class="master-input @(HasError ? "master-input--error" : "")"
           type="@Type"
           value="@Value"
           @oninput="OnInput"
           maxlength="@MaxLength"
           disabled="@Disabled"
           aria-label="@Label"
           aria-invalid="@HasError" />

    <!-- Format/Hint Text -->
    @if (!string.IsNullOrWhiteSpace(FormatText))
    {
    <div class="master-hint">
        @FormatText
    </div>
    }
</div>
@code {
    [Parameter] public string? Label { get; set; }
    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();
    [Parameter] public string Type { get; set; } = "text";
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool Visible { get; set; }
    [Parameter] public string? FormatText { get; set; }
    [Parameter] public int? MaxLength { get; set; }
    /// <summary>
    /// Expression to identify the bound field for validation
    /// </summary>
    [Parameter] public Expression<Func<string>>? For { get; set; }
    /// <summary>
    /// Cascaded EditContext from parent EditForm
    /// </summary>
    [CascadingParameter] private EditContext? EditContext { get; set; }
    /// <summary>
    /// Checks if the field has validation errors
    /// </summary>
    private bool HasError =>
        Visible &&
        EditContext is not null &&
        For is not null &&
        EditContext.GetValidationMessages(FieldIdentifier.Create(For)).Any();
    /// <summary>
    /// Handles input changes and notifies parent
    /// </summary>
    private async Task OnInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);

        if (EditContext is not null && For is not null)
        {
            EditContext.NotifyFieldChanged(FieldIdentifier.Create(For));
        }
    }
}
